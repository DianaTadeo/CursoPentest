#!/usr/bin/python

"""
Programa que realiza una enumeracion de usuarios de correo
mediante el protocolo SMTP.

Autor: Diana Tadeo.
"""

import smtplib
import argparse
from sys import exit

parser = argparse.ArgumentParser("Enumeracion de usuarios SMTP.")
parser.add_argument("-t", "--target", help="IP del host remoto SMTP.", required=True)
parser.add_argument("-u", "--user", help="Usuario del que se desea conocer si se encuentra en el servidor.")
parser.add_argument("-U", "--Users", help="Lista de usuarios sde los cuales se desea conocer si se encuentran. ")
args = parser.parse_args()

user_list=[]
host = args.target
if args.user:
	user_list.append(args.user)
elif args.Users:
	with open(args.Users,'r') as archivo:
		for usuario in archivo:
			user_list.append(usuario)
else:
	print "Se necesita una entrada correcta como usuario o lista de usuarios."
	exit(1)

if __name__ == '__main__':

	server= smtplib.SMTP(host=host)

	for usuario in user_list:
		try:
			resultado = server.verify(usuario.strip())
			respuesta="no se pudo revisar"
			if resultado[0] == 550:
				respuesta="no existe"
			elif resultado[0] == 252:
				respuesta="existe"
			print ("El usuario: %s--%s" %(usuario.strip(),respuesta))
		except Exception as e:
			print("No se pudo realizar la accion.")
			raise
		
